<!-- index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Internship Schedule</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background-color: #000000;
      color: #e0e0e0;
      /* Lighter text for dark background */
      padding: 10px;
      /* Add some padding for small screens */
    }

    #app-container {
      width: 100%;
      max-width: 500px;
      /* Constrain the app width */
      margin: 20px auto;
      /* Center the app container and add vertical margin */
      display: flex;
      flex-direction: column;
      gap: 20px;
      /* Space between cards */
    }

    .card {
      background-color: #1a1a1a;
      border-radius: 12px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      padding: 20px;
      margin-bottom: 20px;
      /* Add space between cards */
    }

    .main-header {
      text-align: center;
      color: #007bff;
      /* Blue font as requested */
      margin-bottom: 20px;
    }

    .main-header .schedule-title {
      font-weight: bold;
      font-size: 1.1em;
    }

    @media (max-width: 400px) {
      .main-header p {
        font-size: 0.9rem;
      }
    }

    #search-card {
      text-align: center;
    }

    .mode-toggle {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 28px;
    }

    #date-wrapper {
      cursor: pointer;
      padding: 5px 0;
      border-radius: 6px;
      transition: background-color 0.2s;
      margin-bottom: 20px;
    }

    #date-wrapper:hover {
      background-color: #1a1a1a;
      /* Darker hover for date wrapper */
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    #current-date {
      margin: 0;
      color: #b0b0b0;
      /* Adjusted for dark theme */
      font-size: 16px;
    }

    #input-wrapper {
      display: flex;
      gap: 10px;
      flex-direction: column;
    }

    input:checked+.slider {
      background-color: #007bff;
    }

    input:checked+.slider:before {
      transform: translateX(22px);
    }

    .input-container {
      position: relative;
      width: 100%;
    }

    #rollInput,
    #department-input,
    #department-select {
      padding: 12px 15px;
      /* padding-right: 50px; */
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #007bff;
      /* Blue border */
      border-radius: 12px;
      background-color: #0d0d0d;
      /* Darker input background */
      color: #e0e0e0;
      /* Light text color */
    }

    .search-button-wrapper {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      /* Remove default border */
      background-color: #007bff;
      color: white;
      border-radius: 8px;
      transition: background-color 0.2s ease, transform 0.1s ease;
      /* Smooth transitions */
      white-space: nowrap;
    }

    button:hover:not(:disabled) {
      background-color: #0056b3;
      transform: translateY(-1px);
      /* Slight lift on hover */
    }

    button:disabled {
      background-color: #333;
      border-color: #333;
      color: #888;
      cursor: not-allowed;
    }

    #student-results-container,
    #faculty-results-container {
      display: none;
      /* Hidden by default */
    }

    .result-card h3,
    .result-card h4 {
      margin-top: 0;
      color: #007bff;
      /* Blue for headings */
      border-bottom: 1px solid #222;
      /* Darker border */
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .result-card p {
      margin: 0 0 10px 0;
      line-height: 1.6;
      color: #b0b0b0;
      /* Adjusted for dark theme */
    }

    .result-card strong {
      color: #e0e0e0;
      /* Adjusted for dark theme */
    }

    #guideline-title {
      display: block;
      margin-bottom: 8px;
    }

    #result-status {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 500;
      color: #b0b0b0;
      /* Adjusted for dark theme */
      text-align: center;
    }

    #faculty-results-container ul {
      list-style-type: none;
      padding: 0;
      text-align: left;
    }

    #faculty-results-container li {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #222;
      /* Darker border */
    }

    #faculty-results-container li:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .report-issue-card {
      text-align: center;
      margin-top: 20px;
    }

    .issue-button {
      display: inline-block;
      padding: 12px 25px;
      background-color: #007bff;
      /* Blue background */
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.2s ease;
      border: none;
      /* Remove default border */
    }

    .issue-button:hover {
      background-color: #0056b3;
      color: white;
      transform: translateY(-1px);
      /* Slight lift on hover */
    }

    .disclaimer {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
      text-align: center;
    }

    .copyright {
      font-size: 12px;
      color: #888;
      /* Adjusted for dark theme */
      text-align: center;
      margin-top: 15px;
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div id="app-container">
    <div id="search-card" class="card">
      <h2 id="dashboard-title">Internship Schedule</h2>
      <div class="mode-toggle">
        <span>Student</span>
        <label class="switch">
          <input type="checkbox" id="mode-toggle-switch">
          <span class="slider"></span>
        </label>
        <span>Faculty</span>
      </div>
      <div id="date-wrapper" title="Click to change date">
        <p id="current-date"></p>
        <input type="date" id="date-picker"
          style="display: none; width: 100%; box-sizing: border-box; font-family: inherit; font-size: 16px; padding: 8px; border: 1px solid #007bff; border-radius: 8px; text-align: center; background-color: #0d0d0d; color: #e0e0e0;">
      </div>
      <div id="input-wrapper">
        <div id="student-input-container" class="input-container">
          <input type="text" id="rollInput" placeholder="Loading data..." disabled />
          <div id="search-button-wrapper" class="search-button-wrapper"><button id="searchButton" disabled>Go</button>
          </div>
        </div>
        <div id="faculty-input-container" class="input-container" style="display: none;">
          <select id="department-select" disabled>
            <option value="">Select a department...</option>
          </select>
        </div>
      </div>
      <p id="result-status"></p>
    </div>

    <div id="student-results-container">
      <div class="card">
        <h3><span id="result-department"></span></h3>
        <p><strong>Posting Site:</strong> <span id="result-site"></span></p>
        <p><strong>Today's Focus:</strong> <span id="result-task"></span></p>
      </div>
      <div class="card">
        <h4>Colleagues in this Posting</h4>
        <p id="result-colleagues">No other colleagues found.</p>
      </div>
      <div class="card">
        <h4>Guideline of the Day</h4>
        <strong id="guideline-title"></strong>
        <p id="guideline-text"></p>
      </div>
      <div class="report-issue-card">
        <a href="https://github.com/Devaprasad-reddy/T2P/issues/new" target="_blank" rel="noopener noreferrer"
          class="issue-button">
          Something not right? Report an issue
        </a>
      </div>
    </div>

    <div id="faculty-results-container" class="card">
    </div>
  </div>

  <script>
    const appData = {};
    const fuzzyDeptSearch = {};
    let currentMode = 'student'; // 'student' or 'faculty'
    let selectedDate = new Date();
    const PIVOT_DATE = new Date('2025-07-21T00:00:00Z'); // The date the new schedule starts

    document.addEventListener("DOMContentLoaded", () => {
      const rollInputElement = document.getElementById("rollInput");
      const searchButton = document.getElementById("searchButton");
      const facultySearchButton = document.getElementById("facultySearchButton");
      const statusElement = document.getElementById("result-status");
      const dateWrapper = document.getElementById("date-wrapper");
      const dateElement = document.getElementById("current-date");
      const datePicker = document.getElementById("date-picker");
      const modeToggle = document.getElementById("mode-toggle-switch");
      const studentInput = document.getElementById("student-input-container");
      const facultyInput = document.getElementById("faculty-input-container");
      const departmentSelect = document.getElementById("department-select");
      const titleElement = document.getElementById("dashboard-title");

      function updateDateDisplay(date) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const today = new Date();
        // Normalize dates to midnight to compare them correctly
        today.setHours(0, 0, 0, 0);
        const displayDate = new Date(date);
        displayDate.setHours(0, 0, 0, 0);

        if (today.getTime() === displayDate.getTime()) {
          dateElement.textContent = `Today is ${date.toLocaleDateString('en-US', options)}`;
        } else {
          dateElement.textContent = `Showing for: ${date.toLocaleDateString('en-US', options)}`;
        }
      }

      // Initial setup
      updateDateDisplay(selectedDate);
      datePicker.value = selectedDate.toISOString().split('T')[0];

      dateWrapper.addEventListener('click', () => {
        dateElement.style.display = 'none';
        datePicker.style.display = 'block';
        datePicker.focus();
      });

      datePicker.addEventListener('change', () => {
        if (!datePicker.value) {
          // If no date is selected, reset to today
          selectedDate = new Date();
        } else {
          // The picker gives a string 'YYYY-MM-DD'. To avoid timezone issues,
          // we create the date object ensuring it's interpreted in the local timezone.
          selectedDate = new Date(datePicker.value + 'T00:00:00');
        }
        updateDateDisplay(selectedDate);
        datePicker.style.display = 'none';
        dateElement.style.display = 'block';

        // If a roll number is already in the input, re-run the search for the new date.
        if (currentMode === 'student' && rollInputElement.value.trim()) {
          lookupStudent();
        } else if (currentMode === 'faculty' && departmentSelect.value.trim()) {
          lookupFaculty(departmentSelect.options[departmentSelect.selectedIndex].dataset.code);
        }
      });

      // When the picker loses focus without a change, it should also hide.
      datePicker.addEventListener('blur', () => {
        datePicker.style.display = 'none';
        dateElement.style.display = 'block';
      });

      modeToggle.addEventListener('change', () => {
        currentMode = modeToggle.checked ? 'faculty' : 'student';
        studentInput.style.display = (currentMode === 'student') ? 'block' : 'none';
        facultyInput.style.display = (currentMode === 'faculty') ? 'block' : 'none';
        titleElement.textContent = (currentMode === 'student') ? 'Internship Schedule' : 'Faculty Department View';

        // Clear results when switching modes
        document.getElementById('student-results-container').style.display = 'none';
        document.getElementById('faculty-results-container').style.display = 'none';
        statusElement.textContent = '';
        rollInputElement.value = ''; // Clear student input
        departmentSelect.value = ''; // Clear faculty input
        searchButton.innerHTML = 'Go'; // Reset search button text
        // Also reset faculty results container and status when switching modes
        document.getElementById('faculty-results-container').style.display = 'none';
        document.getElementById("result-status").textContent = '';
      });

      searchButton.addEventListener('click', () => {
        const studentResultsContainer = document.getElementById('student-results-container');
        const rollInputElement = document.getElementById("rollInput");

        if (studentResultsContainer.style.display === 'block') {
          studentResultsContainer.style.display = 'none';
          rollInputElement.value = '';
          document.getElementById("result-status").textContent = '';
          searchButton.innerHTML = 'Go';
        } else {
          lookupStudent();
        }
      });

      // Removed facultySearchButton.addEventListener('click')

      // Load all data files concurrently
      const dataFiles = {
        groups: 'database/json_data/group-data.json',
        oldGroups: 'database/json_data/old-group-data.json',
        schedule: 'database/json_data/schedule-data.json',
        groupA: 'database/json_data/group-a-schedule.json',
        groupB: 'database/json_data/group-b-schedule.json',
        groupC: 'database/json_data/group-c-schedule.json',
        groupD: 'database/json_data/group-d-schedule.json',
        legend: 'database/json_data/legend.json',
        guidelines: 'database/json_data/guidelines.json',
        regulations: 'database/json_data/regulations.json',
      };

      const promises = Object.entries(dataFiles).map(([key, url]) =>
        fetch(url)
          .then(res => {
            if (!res.ok) throw new Error(`Failed to load ${url}`);
            return res.json();
          })
          .then(data => { appData[key] = data; })
      );

      Promise.all(promises)
        .then(() => {
          console.log("All data loaded successfully:", appData);
          populateDepartmentDatalist();
          buildFuzzySearchData();
          departmentSelect.disabled = false;
          rollInputElement.placeholder = "Enter Roll No. or Group";
          rollInputElement.disabled = false;
          searchButton.disabled = false;
        })
        .catch(error => {
          console.error("Error loading application data:", error);
          statusElement.textContent = "Failed to load data. Please refresh.";
          rollInputElement.placeholder = "Error";
        });

      rollInputElement.addEventListener("keyup", function (event) {
        if (event.key === "Enter") {
          lookupStudent();
        }
      });

      departmentSelect.addEventListener('change', () => {
        const selectedDepartment = departmentSelect.value;
        if (selectedDepartment) {
          const dept = appData.regulations.regulations.find(r => r.department === selectedDepartment);
          if (dept) {
            lookupFaculty(dept.abbreviation);
          }
        } else {
          // Clear results if "Select a department..." is chosen
          document.getElementById('faculty-results-container').style.display = 'none';
          document.getElementById("result-status").textContent = '';
        }
      });
    });

    function populateDepartmentDatalist() {
      const departmentSelect = document.getElementById("department-select");
      departmentSelect.innerHTML = '<option value="">Select a department...</option>'; // Clear and add default option
      appData.regulations.regulations.forEach(reg => {
        if (reg.department && !reg.department.includes('TOTAL')) {
          const option = document.createElement('option');
          option.value = reg.department;
          option.dataset.code = reg.abbreviation;
          option.textContent = reg.department;
          departmentSelect.appendChild(option);
        }
      });
    }

    function buildFuzzySearchData() {
      appData.regulations.regulations.forEach(reg => {
        if (!reg.department || reg.department.includes('TOTAL')) return;

        const code = reg.abbreviation;
        const name = reg.department;

        // The full name is a searchable term, split by common separators
        const nameTerms = name.toLowerCase()
          .split(/[\/,&\(\)]+/) // Split on /, comma, &, and parentheses
          .map(term => term.trim())
          .filter(term => term.length > 1); // Filter out single characters

        const searchTerms = [...nameTerms];
        searchTerms.push(name.toLowerCase()); // Add the full name as a searchable term

        // Add the abbreviation itself (without '*')
        const abbr = code.replace('*', '').toLowerCase();
        if (!searchTerms.includes(abbr)) {
          searchTerms.push(abbr);
        }

        // Add custom aliases
        const customAliases = {
          'PSM': ['psm', 'cm', 'community', 'social', 'preventive', 'medicine'],
          'GM': ['gm', 'medicine', 'general'],
          'GS': ['gs', 'surgery', 'general'],
          'OBG': ['obg', 'obs', 'gyn', 'gynae', 'obstetrics', 'gynaecology'],
          'PED': ['ped', 'paediatrics', 'pediatrics'],
          'ORT': ['ort', 'ortho', 'pmr', 'rehabilitation', 'physical medicine'],
          'OPT': ['opt', 'eye', 'ophth', 'ophthalmology'],
          'ENT': ['ent', 'ear', 'nose', 'throat', 'otorhinolaryngology'],
          'EM': ['em', 'emergency', 'casualty', 'trauma'],
          'ANS': ['ans', 'anesthesia', 'anaesthesia', 'critical', 'care'],
          'PSY': ['psy', 'psych', 'psychiatry'],
          'DVL': ['dvl', 'derm', 'skin', 'venereology', 'leprosy', 'dermatology'],
          'FP': ['fp', 'family', 'welfare', 'planning'],
          'FMT': ['fmt', 'forensic', 'toxicology'],
          'RD*': ['rd', 'radio', 'radiology', 'diagnosis', 'r&l'],
          'LAB*': ['lab', 'path', 'micro', 'pathology', 'microbiology', 'r&l', 'labs'],
          'R&L': ['r&l', 'rl', 'radiology', 'lab', 'pathology', 'radio', 'labs'],
          'TB*': ['tb', 'dots', 'tuberculosis', 'center'],
          'AY*': ['ay', 'ayur', 'ayurvedic', 'medicine']
        };

        if (customAliases[code]) {
          searchTerms.push(...customAliases[code]);
        }

        // Add all unique terms to the fuzzy search map
        new Set(searchTerms).forEach(term => {
          fuzzyDeptSearch[term] = { name: name, code: code };
        });
      });
    }

    function findGroupFromRoll(roll, groupData) {
      const rollAsNumber = parseInt(roll, 10);
      const searchKey = isNaN(rollAsNumber) ? roll.toUpperCase() : rollAsNumber;
      for (const [group, rolls] of Object.entries(groupData)) {
        if (rolls.includes(searchKey)) {
          return group;
        }
      }
      return null;
    }

    /**
     * Finds all colleagues for a given student in a specific week.
     * @param {string} searchedInput - The original roll number or group code that was searched for.
     * @param {string} postingCode - The specific posting code for that student (e.g., "GS - MSW").
     * @param {object} weekSchedule - The weekly schedule object from the detailed view (e.g., group-a-schedule.json).
     * @param {object} groupData - The group-to-roll-number mapping object.
     * @returns {string} A comma-separated string of colleague roll numbers.
     */
    function findColleagues(searchedInput, postingCode, weekSchedule, groupData) {
      // Find all groups that have the exact same posting.
      const allGroupsInPosting = Object.entries(weekSchedule.postings)
        .filter(([group, code]) => code === postingCode)
        .map(([group]) => group);

      // Get a flat list of all roll numbers from those groups.
      const allRollsInPosting = allGroupsInPosting.flatMap(group => groupData[group] || []);

      // If the search was for a specific roll number, filter it out from the colleagues list.
      const searchedRollAsNumber = parseInt(searchedInput, 10);
      const isRollNumberSearch = !isNaN(searchedRollAsNumber);
      const searchKey = isRollNumberSearch ? searchedRollAsNumber : searchedInput.toUpperCase();

      return allRollsInPosting.filter(roll => roll !== searchKey).join(', ');
    }

    /**
     * Returns a list of possible schedule codes for a given department code from regulations.
     * This handles inconsistencies between regulations data and schedule data (e.g., RD* vs R&L).
     * @param {string} deptCode - The department code from the regulations file.
     * @returns {string[]} An array of equivalent codes to search for in schedules.
     */
    function getEquivalentScheduleCodes(deptCode) {
      const equivalents = {
        'RD*': ['R&L'],        // Radio-diagnosis maps to Radiology in old schedule
        'LAB*': ['R&L'],       // Lab Medicine maps to Radiology in old schedule
        'R&L': ['RD*', 'LAB*'], // Radiology maps back to both Lab and Radio-diagnosis
        'TB*': ['TB'],         // TB Center remains consistent
        'FP': ['FP&AY'],       // Family Planning maps to combined posting
        'AY*': ['FP&AY']       // Ayurvedic maps to combined posting
      };
      // Return the original code plus any known equivalents
      return [deptCode, ...(equivalents[deptCode] || [])];
    }

    /**
     * Returns the canonical posting code to handle typos or variations in schedule data.
     * This is used for looking up the site/task in the legend.
     * @param {string} postingCode - The posting code found in the detailed schedule.
     * @returns {string} The canonical posting code for legend lookup.
     */
    function getCanonicalPostingCode(postingCode) {
      const variations = {
        'GM - FMTW': 'GM - FMW',   // Typo in old schedule for Female Medical Ward.
        'FP & AY': 'FWP',          // Combined posting in old schedule; map to FWP for legend lookup.
        'R&L': 'RD*',              // Map Radiology to Radio-diagnosis for legend lookup
        'LABS': 'LAB*'             // Map Labs to Lab Medicine for legend lookup
      };
      return variations[postingCode] || postingCode;
    }

    function lookupStudent() {
      const statusElement = document.getElementById("result-status");
      const studentResultsContainer = document.getElementById("student-results-container");
      statusElement.textContent = "";
      studentResultsContainer.style.display = "none";

      if (Object.keys(appData).length === 0) {
        statusElement.textContent = "Data is not loaded yet.";
        return;
      }

      const rollInputElement = document.getElementById("rollInput");
      let rollInput = rollInputElement.value.trim().toUpperCase();

      if (!rollInput) {
        statusElement.textContent = "Please enter a roll number or group code.";
        return;
      }

      // --- Normalize 'R' codes with leading zeros (e.g., R07 -> R7) ---
      if (rollInput.startsWith('R0')) {
        rollInput = rollInput.replace(/^R0+/, 'R');
      }

      // --- Determine which schedule and group data to use ---
      const isOldSchedule = selectedDate < PIVOT_DATE;
      const scheduleKey = isOldSchedule ? 'oldSchedule' : 'newSchedule';
      const groupData = isOldSchedule ? appData.oldGroups : appData.groups;

      // --- Find the student's group code ---
      let studentGroupCode = findGroupFromRoll(rollInput, groupData);
      if (!studentGroupCode) {
        // If not found as a roll, check if it's a valid group code itself
        if (groupData[rollInput]) {
          studentGroupCode = rollInput;
        } else {
          // If not found, check the OTHER schedule's group data for a better error message.
          const otherGroupData = isOldSchedule ? appData.groups : appData.oldGroups;
          const foundInOther = findGroupFromRoll(rollInput, otherGroupData);
          if (foundInOther) {
            const scheduleType = isOldSchedule ? 'new' : 'old';
            const scheduleDate = PIVOT_DATE.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            statusElement.textContent = `Roll No. '${rollInput}' is found in the ${scheduleType} schedule (from ${scheduleDate}), but not in the schedule valid for the selected date.`;
          } else {
            statusElement.textContent = `No group found for '${rollInput}'.`;
          }
          return; // Stop execution
        }
      }

      // --- Find the correct schedule data ---
      const groupLetter = studentGroupCode.charAt(0);
      const detailedScheduleData = appData[`group${groupLetter}`];
      if (!detailedScheduleData) {
        statusElement.textContent = `Could not find schedule for group ${groupLetter}.`;
        return;
      }

      // --- Find the current week's posting ---
      // The detailed schedule (e.g., group-a-schedule.json) is used to find the specific posting.
      const lookupDateStr = selectedDate.toISOString().split('T')[0];
      const weekSchedule = detailedScheduleData[scheduleKey].find(week =>
        lookupDateStr >= week.startDate && lookupDateStr <= week.endDate
      );
      // The "at a glance" schedule is used to find the major department.
      const atAGlanceWeek = appData.schedule[scheduleKey].find(week =>
        lookupDateStr >= week.startDate && lookupDateStr <= week.endDate
      );

      if (!weekSchedule || !atAGlanceWeek) {
        statusElement.textContent = `No posting found for the selected date.`;
        return;
      }

      const postingCode = weekSchedule.postings[studentGroupCode]; // e.g., "GS - MSW" from the detailed schedule
      const departmentCode = atAGlanceWeek.postings[studentGroupCode]; // e.g., "GS" from the at-a-glance schedule

      if (!postingCode || !departmentCode) {
        statusElement.textContent = `Posting details not found for group ${studentGroupCode}.`;
        return;
      }

      // --- Look up details in the legend ---
      const canonicalPostingCode = getCanonicalPostingCode(postingCode);
      const legendEntry = appData.legend.legend.find(item => item.code === canonicalPostingCode);
      const departmentEntry = appData.regulations.regulations.find(item => item.abbreviation === departmentCode);

      const colleagueRolls = findColleagues(rollInput, postingCode, weekSchedule, groupData); // Use raw postingCode for colleague lookup

      // --- Get a random guideline ---
      const randomGuideline = appData.guidelines[Math.floor(Math.random() * appData.guidelines.length)];

      // --- Update the DOM with all the information ---
      document.getElementById('result-department').textContent = departmentEntry?.department || departmentCode;
      document.getElementById('result-site').textContent = legendEntry?.site || postingCode;
      document.getElementById('result-task').textContent = legendEntry?.split || "No specific task description found.";
      document.getElementById('result-colleagues').textContent = colleagueRolls || "You are posted alone or with a different subgroup.";
      document.getElementById('guideline-title').textContent = randomGuideline.title;
      document.getElementById('guideline-text').textContent = randomGuideline.points.join(' ');

      studentResultsContainer.style.display = "block";
      searchButton.innerHTML = '<strong style="font-size: 1.2em;">X</strong>';
    }

    function lookupFaculty(departmentCode) {
      const statusElement = document.getElementById("result-status");
      const facultyResultsContainer = document.getElementById("faculty-results-container");
      statusElement.textContent = "";
      facultyResultsContainer.style.display = "none";
      facultyResultsContainer.innerHTML = '';

      const isOldSchedule = selectedDate < PIVOT_DATE;
      const scheduleKey = isOldSchedule ? 'oldSchedule' : 'newSchedule';
      const groupData = isOldSchedule ? appData.oldGroups : appData.groups;

      const atAGlanceWeek = appData.schedule[scheduleKey].find(week =>
        selectedDate.toISOString().split('T')[0] >= week.startDate && selectedDate.toISOString().split('T')[0] <= week.endDate
      );

      if (!atAGlanceWeek) {
        statusElement.textContent = `No schedule found for the selected date.`;
        return;
      }

      const postingsBySite = {};

      const searchCodes = getEquivalentScheduleCodes(departmentCode);

      for (const groupCode of Object.keys(atAGlanceWeek.postings)) {
        if (searchCodes.includes(atAGlanceWeek.postings[groupCode])) {
          const groupLetter = groupCode.charAt(0);
          const detailedScheduleData = appData[`group${groupLetter}`];
          const weekSchedule = detailedScheduleData[scheduleKey].find(w => w.startDate === atAGlanceWeek.startDate);

          if (weekSchedule && weekSchedule.postings[groupCode]) {
            const rawPostingCode = weekSchedule.postings[groupCode];
            const canonicalPostingCode = getCanonicalPostingCode(rawPostingCode);
            const legendEntry = appData.legend.legend.find(item => item.code === canonicalPostingCode);
            const siteName = legendEntry?.site || rawPostingCode;

            if (!postingsBySite[siteName]) {
              postingsBySite[siteName] = [];
            }
            postingsBySite[siteName].push(...(groupData[groupCode] || []));
          }
        }
      }

      if (Object.keys(postingsBySite).length === 0) {
        statusElement.textContent = `No students found in ${departmentCode} for the selected date.`;
        return;
      }

      let html = '<ul>';
      for (const [site, rolls] of Object.entries(postingsBySite)) {
        html += `<li><strong>${site}:</strong><br>${rolls.join(', ')}</li>`;
      }
      html += '</ul>';

      facultyResultsContainer.innerHTML = html;
      facultyResultsContainer.style.display = 'block';
      facultySearchButton.innerHTML = '<strong style="font-size: 1.2em;">X</strong>';
    }
  </script>
</body>

</html>