<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Internship Schedule</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f2f5;
      padding: 20px;
      box-sizing: border-box;
    }
    #app-container {
      width: 100%;
      max-width: 500px;
    }
    .card {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 25px 30px;
      margin-bottom: 20px;
    }
    #search-card {
      text-align: center;
    }
    #dashboard-title {
      margin-top: 0;
    }
    .mode-toggle {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 28px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 28px;
    }
    #date-wrapper {
      cursor: pointer;
      padding: 5px 0;
      border-radius: 6px;
      transition: background-color 0.2s;
      margin-bottom: 20px;
    }
    #date-wrapper:hover {
      background-color: #e9ecef;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    #current-date {
      margin: 0;
      color: #555;
      font-size: 16px;
    }
    #input-wrapper {
      display: flex;
      gap: 10px;
      flex-direction: column;
    }
    input:checked + .slider {
      background-color: #007bff;
    }
    input:checked + .slider:before {
      transform: translateX(22px);
    }
    #rollInput,
    #department-select {
      padding: 10px;
      font-size: 16px;
      flex-grow: 1;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #search-button-wrapper {
      display: flex;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid #007bff;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      flex-grow: 1;
      transition: background-color 0.2s;
    }
    button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
    }
    #student-results-container,
    #faculty-results-container {
      display: none; /* Hidden by default */
    }
    .result-card h3, .result-card h4 {
      margin-top: 0;
      color: #0056b3;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .result-card p {
      margin: 0 0 10px 0;
      line-height: 1.6;
      color: #333;
    }
    .result-card strong {
      color: #111;
    }
    #guideline-title {
      display: block;
      margin-bottom: 8px;
    }
    #result-status {
      margin-top: 20px;
      font-size: 18px;
      font-weight: 500;
      color: #333;
      text-align: center;
    }
    #faculty-results-container ul {
      list-style-type: none;
      padding: 0;
      text-align: left;
    }
    #faculty-results-container li {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f2f5;
    }
    #faculty-results-container li:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <div id="search-card" class="card">
      <h2 id="dashboard-title">Internship Schedule</h2>
      <div class="mode-toggle">
        <span>Student</span>
        <label class="switch">
          <input type="checkbox" id="mode-toggle-switch">
          <span class="slider"></span>
        </label>
        <span>Faculty</span>
      </div>
      <div id="date-wrapper" title="Click to change date">
        <p id="current-date"></p>
        <input type="date" id="date-picker" style="display: none; width: 100%; box-sizing: border-box; font-family: inherit; font-size: 16px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center;">
      </div>
      <div id="input-wrapper">
        <div id="student-input-container"><input type="text" id="rollInput" placeholder="Loading data..." disabled /></div>
        <div id="faculty-input-container" style="display: none;"><select id="department-select" disabled><option>Loading departments...</option></select></div>
        <div id="search-button-wrapper"><button id="searchButton" disabled>Search</button></div>
      </div>
      <p id="result-status"></p>
    </div>

    <div id="student-results-container">
      <div class="card">
        <h3><span id="result-department"></span></h3>
        <p><strong>Posting Site:</strong> <span id="result-site"></span></p>
        <p><strong>Today's Focus:</strong> <span id="result-task"></span></p>
      </div>
      <div class="card">
        <h4>Colleagues in this Posting</h4>
        <p id="result-colleagues">No other colleagues found.</p>
      </div>
      <div class="card">
        <h4>Guideline of the Day</h4>
        <strong id="guideline-title"></strong>
        <p id="guideline-text"></p>
      </div>
    </div>

    <div id="faculty-results-container" class="card"></div>
  </div>

  <script>
    const appData = {};
    let currentMode = 'student'; // 'student' or 'faculty'
    let selectedDate = new Date();
    const PIVOT_DATE = new Date('2025-07-21T00:00:00Z'); // The date the new schedule starts

    document.addEventListener("DOMContentLoaded", () => {
      const rollInputElement = document.getElementById("rollInput");
      const searchButton = document.getElementById("searchButton");
      const statusElement = document.getElementById("result-status");
      const dateWrapper = document.getElementById("date-wrapper");
      const dateElement = document.getElementById("current-date");
      const datePicker = document.getElementById("date-picker");
      const modeToggle = document.getElementById("mode-toggle-switch");
      const studentInput = document.getElementById("student-input-container");
      const facultyInput = document.getElementById("faculty-input-container");
      const departmentSelect = document.getElementById("department-select");
      const titleElement = document.getElementById("dashboard-title");

      function updateDateDisplay(date) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const today = new Date();
        // Normalize dates to midnight to compare them correctly
        today.setHours(0, 0, 0, 0);
        const displayDate = new Date(date);
        displayDate.setHours(0, 0, 0, 0);

        if (today.getTime() === displayDate.getTime()) {
          dateElement.textContent = `Today is ${date.toLocaleDateString('en-US', options)}`;
        } else {
          dateElement.textContent = `Showing for: ${date.toLocaleDateString('en-US', options)}`;
        }
      }

      // Initial setup
      updateDateDisplay(selectedDate);
      datePicker.value = selectedDate.toISOString().split('T')[0];

      dateWrapper.addEventListener('click', () => {
        dateElement.style.display = 'none';
        datePicker.style.display = 'block';
        datePicker.focus();
      });

      datePicker.addEventListener('change', () => {
        // The picker gives a string 'YYYY-MM-DD'. To avoid timezone issues,
        // we create the date object ensuring it's interpreted in the local timezone.
        selectedDate = new Date(datePicker.value + 'T00:00:00');
        updateDateDisplay(selectedDate);
        datePicker.style.display = 'none';
        dateElement.style.display = 'block';

        // If a roll number is already in the input, re-run the search for the new date.
        if (currentMode === 'student' && rollInputElement.value.trim()) {
          lookupStudent();
        }
      });

      // When the picker loses focus without a change, it should also hide.
      datePicker.addEventListener('blur', () => {
        datePicker.style.display = 'none';
        dateElement.style.display = 'block';
      });

      modeToggle.addEventListener('change', () => {
        currentMode = modeToggle.checked ? 'faculty' : 'student';
        studentInput.style.display = (currentMode === 'student') ? 'block' : 'none';
        facultyInput.style.display = (currentMode === 'faculty') ? 'block' : 'none';
        titleElement.textContent = (currentMode === 'student') ? 'Internship Schedule' : 'Faculty Department View';

        // Clear results when switching modes
        document.getElementById('student-results-container').style.display = 'none';
        document.getElementById('faculty-results-container').style.display = 'none';
        statusElement.textContent = '';
      });

      searchButton.addEventListener('click', () => {
        const studentResultsContainer = document.getElementById('student-results-container');
        const facultyResultsContainer = document.getElementById('faculty-results-container');

        // If results are already visible, reload the page to reset for a new search.
        if (studentResultsContainer.style.display === 'block' || facultyResultsContainer.style.display === 'block') {
          location.reload();
        } else {
          // Otherwise, perform the search based on the current mode.
          if (currentMode === 'student') {
            lookupStudent();
          } else {
            lookupFaculty();
          }
        }
      });

      // Load all data files concurrently
      const dataFiles = {
        groups: 'database/json_data/group-data.json',
        oldGroups: 'database/json_data/old-group-data.json',
        schedule: 'database/json_data/schedule-data.json',
        groupA: 'database/json_data/group-a-schedule.json',
        groupB: 'database/json_data/group-b-schedule.json',
        groupC: 'database/json_data/group-c-schedule.json',
        groupD: 'database/json_data/group-d-schedule.json',
        legend: 'database/json_data/legend.json',
        guidelines: 'database/json_data/guidelines.json',
        regulations: 'database/json_data/regulations.json',
      };

      const promises = Object.entries(dataFiles).map(([key, url]) =>
        fetch(url)
        .then(res => {
          if (!res.ok) throw new Error(`Failed to load ${url}`);
          return res.json();
        })
        .then(data => { appData[key] = data; })
      );

      Promise.all(promises)
        .then(() => {
          console.log("All data loaded successfully:", appData);
          populateDepartments();
          departmentSelect.disabled = false;
          rollInputElement.placeholder = "Enter Roll No. or Group";
          rollInputElement.disabled = false;
          searchButton.disabled = false;
        })
        .catch(error => {
          console.error("Error loading application data:", error);
          statusElement.textContent = "Failed to load data. Please refresh.";
          rollInputElement.placeholder = "Error";
        });

      rollInputElement.addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
          lookupStudent();
        }
      });
    });

    function populateDepartments() {
      const departmentSelect = document.getElementById("department-select");
      departmentSelect.innerHTML = ''; // Clear loading message
      const departments = new Set();
      appData.regulations.regulations.forEach(reg => {
        if (reg.department && !reg.department.includes('TOTAL')) departments.add(reg.abbreviation);
      });
      departments.forEach(deptCode => {
        const option = document.createElement('option');
        option.value = deptCode;
        option.textContent = appData.regulations.regulations.find(r => r.abbreviation === deptCode).department;
        departmentSelect.appendChild(option);
      });
    }

    function findGroupFromRoll(roll, groupData) {
      const rollAsNumber = parseInt(roll, 10);
      const searchKey = isNaN(rollAsNumber) ? roll.toUpperCase() : rollAsNumber;
      for (const [group, rolls] of Object.entries(groupData)) {
        if (rolls.includes(searchKey)) {
          return group;
        }
      }
      return null;
    }

    /**
     * Finds all colleagues for a given student in a specific week.
     * @param {string} searchedInput - The original roll number or group code that was searched for.
     * @param {string} postingCode - The specific posting code for that student (e.g., "GS - MSW").
     * @param {object} weekSchedule - The weekly schedule object from the detailed view (e.g., group-a-schedule.json).
     * @param {object} groupData - The group-to-roll-number mapping object.
     * @returns {string} A comma-separated string of colleague roll numbers.
     */
    function findColleagues(searchedInput, postingCode, weekSchedule, groupData) {
      // Find all groups that have the exact same posting.
      const allGroupsInPosting = Object.entries(weekSchedule.postings)
        .filter(([group, code]) => code === postingCode)
        .map(([group]) => group);

      // Get a flat list of all roll numbers from those groups.
      const allRollsInPosting = allGroupsInPosting.flatMap(group => groupData[group] || []);

      // If the search was for a specific roll number, filter it out from the colleagues list.
      const searchedRollAsNumber = parseInt(searchedInput, 10);
      const isRollNumberSearch = !isNaN(searchedRollAsNumber);
      const searchKey = isRollNumberSearch ? searchedRollAsNumber : searchedInput.toUpperCase();

      return allRollsInPosting.filter(roll => roll !== searchKey).join(', ');
    }

    function lookupStudent() {
      const statusElement = document.getElementById("result-status");
      const studentResultsContainer = document.getElementById("student-results-container");
      statusElement.textContent = "";
      studentResultsContainer.style.display = "none";

      if (Object.keys(appData).length === 0) {
        statusElement.textContent = "Data is not loaded yet.";
        return;
      }

      const rollInputElement = document.getElementById("rollInput");
      let rollInput = rollInputElement.value.trim().toUpperCase();

      if (!rollInput) {
        statusElement.textContent = "Please enter a roll number or group code.";
        return;
      }

      // --- Normalize 'R' codes with leading zeros (e.g., R07 -> R7) ---
      if (rollInput.startsWith('R0')) {
        rollInput = rollInput.replace(/^R0+/, 'R');
      }

      // --- Determine which schedule and group data to use ---
      const isOldSchedule = selectedDate < PIVOT_DATE;
      const scheduleKey = isOldSchedule ? 'oldSchedule' : 'newSchedule';
      const groupData = isOldSchedule ? appData.oldGroups : appData.groups;

      // --- Find the student's group code ---
      let studentGroupCode = findGroupFromRoll(rollInput, groupData);
      if (!studentGroupCode) {
        // If not found as a roll, check if it's a valid group code itself
        if (groupData[rollInput]) {
          studentGroupCode = rollInput;
        } else {
          // If not found, check the OTHER schedule's group data for a better error message.
          const otherGroupData = isOldSchedule ? appData.groups : appData.oldGroups;
          const foundInOther = findGroupFromRoll(rollInput, otherGroupData);
          if (foundInOther) {
            const scheduleType = isOldSchedule ? 'new' : 'old';
            const scheduleDate = PIVOT_DATE.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            statusElement.textContent = `Roll No. '${rollInput}' is found in the ${scheduleType} schedule (from ${scheduleDate}), but not in the schedule valid for the selected date.`;
          } else {
            statusElement.textContent = `No group found for '${rollInput}'.`;
          }
          return; // Stop execution
        }
      }

      // --- Find the correct schedule data ---
      const groupLetter = studentGroupCode.charAt(0);
      const detailedScheduleData = appData[`group${groupLetter}`];
      if (!detailedScheduleData) {
        statusElement.textContent = `Could not find schedule for group ${groupLetter}.`;
        return;
      }

      // --- Find the current week's posting ---
      // The detailed schedule (e.g., group-a-schedule.json) is used to find the specific posting.
      const lookupDateStr = selectedDate.toISOString().split('T')[0];
      const weekSchedule = detailedScheduleData[scheduleKey].find(week =>
        lookupDateStr >= week.startDate && lookupDateStr <= week.endDate
      );
      // The "at a glance" schedule is used to find the major department.
      const atAGlanceWeek = appData.schedule[scheduleKey].find(week =>
        lookupDateStr >= week.startDate && lookupDateStr <= week.endDate
      );

      if (!weekSchedule || !atAGlanceWeek) {
        statusElement.textContent = `No posting found for the selected date.`;
        return;
      }

      const postingCode = weekSchedule.postings[studentGroupCode]; // e.g., "GS - MSW" from the detailed schedule
      const departmentCode = atAGlanceWeek.postings[studentGroupCode]; // e.g., "GS" from the at-a-glance schedule

      if (!postingCode || !departmentCode) {
        statusElement.textContent = `Posting details not found for group ${studentGroupCode}.`;
        return;
      }

      // --- Look up details in the legend ---
      const legendEntry = appData.legend.legend.find(item => item.code === postingCode);
      const departmentEntry = appData.regulations.regulations.find(item => item.abbreviation === departmentCode);

      const colleagueRolls = findColleagues(rollInput, postingCode, weekSchedule, groupData);

      // --- Get a random guideline ---
      const randomGuideline = appData.guidelines[Math.floor(Math.random() * appData.guidelines.length)];

      // --- Update the DOM with all the information ---
      document.getElementById('result-department').textContent = departmentEntry?.department || departmentCode;
      document.getElementById('result-site').textContent = legendEntry?.site || postingCode;
      document.getElementById('result-task').textContent = legendEntry?.split || "No specific task description found.";
      document.getElementById('result-colleagues').textContent = colleagueRolls || "You are posted alone or with a different subgroup.";
      document.getElementById('guideline-title').textContent = randomGuideline.title;
      document.getElementById('guideline-text').textContent = randomGuideline.points.join(' ');

      studentResultsContainer.style.display = "block";
    }

    function lookupFaculty() {
      const statusElement = document.getElementById("result-status");
      const facultyResultsContainer = document.getElementById("faculty-results-container");
      statusElement.textContent = "";
      facultyResultsContainer.style.display = "none";
      facultyResultsContainer.innerHTML = '';

      const departmentCode = document.getElementById("department-select").value;
      if (!departmentCode) {
        statusElement.textContent = "Please select a department.";
        return;
      }

      const isOldSchedule = selectedDate < PIVOT_DATE;
      const scheduleKey = isOldSchedule ? 'oldSchedule' : 'newSchedule';
      const groupData = isOldSchedule ? appData.oldGroups : appData.groups;

      const atAGlanceWeek = appData.schedule[scheduleKey].find(week =>
        selectedDate.toISOString().split('T')[0] >= week.startDate && selectedDate.toISOString().split('T')[0] <= week.endDate
      );

      if (!atAGlanceWeek) {
        statusElement.textContent = `No schedule found for the selected date.`;
        return;
      }

      const postingsBySite = {};

      for (const groupCode of Object.keys(atAGlanceWeek.postings)) {
        if (atAGlanceWeek.postings[groupCode] === departmentCode) {
          const groupLetter = groupCode.charAt(0);
          const detailedScheduleData = appData[`group${groupLetter}`];
          const weekSchedule = detailedScheduleData[scheduleKey].find(w => w.startDate === atAGlanceWeek.startDate);

          if (weekSchedule && weekSchedule.postings[groupCode]) {
            const postingCode = weekSchedule.postings[groupCode];
            const legendEntry = appData.legend.legend.find(item => item.code === postingCode);
            const siteName = legendEntry?.site || postingCode;

            if (!postingsBySite[siteName]) {
              postingsBySite[siteName] = [];
            }
            postingsBySite[siteName].push(...(groupData[groupCode] || []));
          }
        }
      }

      if (Object.keys(postingsBySite).length === 0) {
        statusElement.textContent = `No students found in ${departmentCode} for the selected date.`;
        return;
      }

      let html = '<ul>';
      for (const [site, rolls] of Object.entries(postingsBySite)) {
        html += `<li><strong>${site}:</strong><br>${rolls.join(', ')}</li>`;
      }
      html += '</ul>';

      facultyResultsContainer.innerHTML = html;
      facultyResultsContainer.style.display = 'block';
    }
  </script>
</body>
</html>